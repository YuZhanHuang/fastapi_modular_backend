# æ€§èƒ½åˆ†æï¼šå°è±¡å‰µå»ºèˆ‡ GC å£“åŠ›

## æ¦‚è¿°

æœ¬æ–‡æª”åˆ†æç•¶å‰æ¶æ§‹åœ¨é«˜ä¸¦ç™¼å ´æ™¯ä¸‹çš„æ€§èƒ½è¡¨ç¾ï¼Œç‰¹åˆ¥é—œæ³¨å°è±¡å‰µå»ºé–‹éŠ·å’Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰å£“åŠ›ã€‚

---

## å•é¡ŒèƒŒæ™¯

### æ ¸å¿ƒç–‘å•

åœ¨ç•¶å‰æ¶æ§‹ä¸­ï¼Œæ¯å€‹ HTTP è«‹æ±‚éƒ½æœƒå‰µå»ºæ–°çš„ Service å’Œ Repository å¯¦ä¾‹ï¼Œè€Œæ²’æœ‰ä½¿ç”¨å–®ä¾‹æ¨¡å¼ã€‚é€™å¼•ç™¼äº†ä»¥ä¸‹ç–‘å•ï¼š

1. **é«˜è«‹æ±‚é‡ä¸‹ï¼Œæ˜¯å¦æœƒè®“ Python è§£é‡‹å™¨å¿™æ–¼ GCï¼Ÿ**
2. **è¨˜æ†¶é«”æ˜¯å¦æœƒåœ¨å¾ˆå¿«çš„æ™‚é–“å…§è¢«ä½”æ»¿ï¼Ÿ**
3. **æ˜¯å¦éœ€è¦å¼•å…¥å–®ä¾‹æ¨¡å¼ï¼Ÿ**

---

## ä¸€ã€ç•¶å‰æ¶æ§‹çš„å°è±¡å‰µå»ºæƒ…æ³

### æ¯å€‹è«‹æ±‚çš„å°è±¡å‰µå»ºæµç¨‹

```
HTTP è«‹æ±‚ï¼šGET /api/cart?user_id=123
  â†“
1. Session å¯¦ä¾‹ï¼ˆé€šé get_sessionï¼‰            # â† æ–°å°è±¡
  â†“
2. DependencyResolver å¯¦ä¾‹                    # â† æ–°å°è±¡
  â†“
3. CartRepositoryImpl å¯¦ä¾‹                    # â† æ–°å°è±¡
  â†“
4. CartService å¯¦ä¾‹                           # â† æ–°å°è±¡
  â†“
5. Cart Domain Model                         # â† æ–°å°è±¡
  â†“
6. CartOut API Schema                        # â† æ–°å°è±¡
```

### å°è±¡åˆ†é¡

#### æ¯æ¬¡è«‹æ±‚éƒ½å‰µå»ºçš„å°è±¡ âš ï¸

| å°è±¡é¡å‹ | æ•¸é‡ | ç”Ÿå‘½é€±æœŸ |
|---------|------|---------|
| `Session` | 1 | è«‹æ±‚çµæŸæ™‚é—œé–‰ |
| `DependencyResolver` | 1 | è«‹æ±‚çµæŸæ™‚éŠ·æ¯€ |
| `Repository` å¯¦ä¾‹ | 1-N | è«‹æ±‚çµæŸæ™‚éŠ·æ¯€ |
| `Service` å¯¦ä¾‹ | 1-N | è«‹æ±‚çµæŸæ™‚éŠ·æ¯€ |
| `Domain Model` | å¯èƒ½å¤šå€‹ | è«‹æ±‚çµæŸæ™‚éŠ·æ¯€ |
| `API Schema` | å¯èƒ½å¤šå€‹ | è«‹æ±‚çµæŸæ™‚éŠ·æ¯€ |

#### åªåˆå§‹åŒ–ä¸€æ¬¡çš„å°è±¡ âœ…

| å°è±¡é¡å‹ | æ•¸é‡ | ç”Ÿå‘½é€±æœŸ |
|---------|------|---------|
| `DependencyRegistry`ï¼ˆè¨»å†Šè¡¨ï¼‰ | 1 | æ‡‰ç”¨ç”Ÿå‘½é€±æœŸ |
| `_repository_map` | 1 | æ‡‰ç”¨ç”Ÿå‘½é€±æœŸ |
| `_services` | 1 | æ‡‰ç”¨ç”Ÿå‘½é€±æœŸ |

---

## äºŒã€é«˜ä¸¦ç™¼å ´æ™¯ä¸‹çš„æ½›åœ¨å•é¡Œ

### å ´æ™¯ï¼šæ¯ç§’ 1000 å€‹è«‹æ±‚ï¼ˆ1000 QPSï¼‰

#### 1. æ¯ç§’å‰µå»ºçš„å°è±¡æ•¸é‡

```
åŸºç¤å°è±¡ï¼š
- Session: 1000 å€‹
- DependencyResolver: 1000 å€‹
- CartService: 1000 å€‹
- CartRepositoryImpl: 1000 å€‹

æ¥­å‹™å°è±¡ï¼ˆå‡è¨­å¹³å‡æ¯å€‹è«‹æ±‚ï¼‰ï¼š
- Domain Model: 2000 å€‹
- API Schema: 2000 å€‹

ç¸½è¨ˆï¼šæ¯ç§’ç´„ 8000 å€‹å°è±¡å‰µå»ºèˆ‡éŠ·æ¯€
```

#### 2. Python GC æ©Ÿåˆ¶

**Python æ¡ç”¨åˆ†ä»£åƒåœ¾å›æ”¶ï¼ˆGenerational GCï¼‰ï¼š**

```python
Generation 0: çŸ­ç”Ÿå‘½é€±æœŸå°è±¡ï¼ˆæ‚¨çš„ Serviceã€Repositoryï¼‰
Generation 1: ä¸­æœŸå°è±¡
Generation 2: é•·æœŸå°è±¡ï¼ˆè¨»å†Šè¡¨ç­‰ï¼‰

# Python é»˜èªé–¾å€¼
gc.get_threshold()  # (700, 10, 10)
# æ„æ€ï¼š700 å€‹æ–°å°è±¡æœƒè§¸ç™¼ Gen 0 GC
```

**åœ¨ 1000 QPS ä¸‹ï¼š**

```
æ¯ç§’ 8000 å€‹å°è±¡ Ã· 700ï¼ˆé–¾å€¼ï¼‰= æ¯ç§’è§¸ç™¼ç´„ 11 æ¬¡ Gen 0 GC

å–®æ¬¡ Gen 0 GC è€—æ™‚ï¼š1-5 æ¯«ç§’
ç¸½ GC æ™‚é–“ï¼š11 Ã— 1-5ms = 11-55 æ¯«ç§’/ç§’
ä½”æ¯”ï¼š1.1% - 5.5%
```

**å½±éŸ¿ï¼š**
- âš ï¸ æœƒå½±éŸ¿ **P99 å»¶é²**ï¼ˆå°¾å»¶é²ï¼‰
- âš ï¸ GC æœŸé–“æœƒæœ‰çŸ­æš«çš„ **Stop-The-World** åœé “
- âœ… å°å¹³å‡å»¶é²å½±éŸ¿ä¸å¤§

---

## ä¸‰ã€è¨˜æ†¶é«”ä½”ç”¨åˆ†æ

### å–®å€‹è«‹æ±‚çš„è¨˜æ†¶é«”ä½”ç”¨ä¼°ç®—

```python
# ç²—ç•¥ä¼°ç®—ï¼ˆä¸åŒ…å«æ•¸æ“šéƒ¨åˆ†ï¼‰
CartService å¯¦ä¾‹: ~200 bytesï¼ˆå°è±¡é ­ + å±¬æ€§å¼•ç”¨ï¼‰
CartRepositoryImpl å¯¦ä¾‹: ~300 bytes
Session å¯¦ä¾‹: ~1KBï¼ˆåŒ…å«é€£æ¥æ± ç›¸é—œï¼‰
DependencyResolver: ~500 bytes
Domain Model (Cart): ~1KBï¼ˆå–æ±ºæ–¼æ•¸æ“šå¤§å°ï¼‰
API Schema: ~500 bytes

å–®æ¬¡è«‹æ±‚ç¸½è¨ˆ: ç´„ 3.5KB
```

### 1000 QPS çš„è¨˜æ†¶é«”å£“åŠ›

```
æ¯ç§’æ–°å¢å°è±¡: 3.5KB Ã— 1000 = 3.5MB/ç§’

å‡è¨­å¹³å‡è«‹æ±‚è™•ç†æ™‚é–“ 100msï¼ˆ0.1 ç§’ï¼‰
åŒæ™‚å­˜åœ¨çš„å°è±¡: 3.5MB Ã— 0.1 = 350KB

å‡è¨­å¹³å‡è«‹æ±‚è™•ç†æ™‚é–“ 500msï¼ˆ0.5 ç§’ï¼‰
åŒæ™‚å­˜åœ¨çš„å°è±¡: 3.5MB Ã— 0.5 = 1.75MB

å‡è¨­å¹³å‡è«‹æ±‚è™•ç†æ™‚é–“ 1000msï¼ˆ1 ç§’ï¼‰
åŒæ™‚å­˜åœ¨çš„å°è±¡: 3.5MB Ã— 1 = 3.5MB
```

**çµè«–ï¼š**
- âœ… **è¨˜æ†¶é«”ä½”ç”¨æœ¬èº«ä¸æ˜¯ä¸»è¦å•é¡Œ**
- âœ… é™¤éè«‹æ±‚è™•ç†æ™‚é–“éå¸¸é•·ï¼ˆ> 1 ç§’ï¼‰
- ğŸ”´ **GC å£“åŠ›æ‰æ˜¯ä¸»è¦å•é¡Œ**

---

## å››ã€èˆ‡å–®ä¾‹æ¨¡å¼çš„å°æ¯”

### æ–¹æ¡ˆ Aï¼šç•¶å‰æ¶æ§‹ï¼ˆæ¯æ¬¡å‰µå»ºæ–°å¯¦ä¾‹ï¼‰

```python
# æ¯å€‹è«‹æ±‚
service = CartService(cart_repo=CartRepositoryImpl(session))
```

**å„ªé»ï¼š**
- âœ… **ç·šç¨‹å®‰å…¨**ï¼šæ¯å€‹è«‹æ±‚ç¨ç«‹ï¼Œç„¡ç‹€æ…‹ç«¶çˆ­
- âœ… **ç„¡å…±äº«ç‹€æ…‹**ï¼šé¿å…ä¸¦ç™¼å•é¡Œ
- âœ… **æ˜“æ–¼ç†è§£**ï¼šä»£ç¢¼æµç¨‹æ¸…æ™°
- âœ… **æ˜“æ–¼æ¸¬è©¦**ï¼šæ¯å€‹å¯¦ä¾‹ç¨ç«‹å¯æ¸¬
- âœ… **ç¬¦åˆ Clean Architecture**ï¼šä¾è³´æ³¨å…¥æ¸…æ™°

**ç¼ºé»ï¼š**
- âŒ **å°è±¡å‰µå»ºé–‹éŠ·**ï¼šæ¯æ¬¡è«‹æ±‚éƒ½å‰µå»º
- âŒ **GC å£“åŠ›**ï¼šå¤§é‡çŸ­ç”Ÿå‘½é€±æœŸå°è±¡
- âŒ **ç„¡é‡ç”¨**ï¼šç„¡æ³•è·¨è«‹æ±‚å…±äº«

### æ–¹æ¡ˆ Bï¼šService å–®ä¾‹æ¨¡å¼

```python
# å…¨å±€å–®ä¾‹ï¼ˆå½ä»£ç¢¼ï¼‰
_cart_service_singleton = None

def get_cart_service(session):
    global _cart_service_singleton
    if not _cart_service_singleton:
        _cart_service_singleton = CartService(...)
    return _cart_service_singleton
```

**å„ªé»ï¼š**
- âœ… **æ¸›å°‘å°è±¡å‰µå»º**ï¼šåªå‰µå»ºä¸€æ¬¡
- âœ… **æ¸›å°‘ GC å£“åŠ›**ï¼šå°è±¡é•·æœŸå­˜åœ¨

**ç¼ºé»ï¼š**
- âŒ **Session ä¾è³´å•é¡Œ**ï¼šRepository éœ€è¦ Sessionï¼Œä¸èƒ½å…±äº«
- âŒ **ç·šç¨‹å®‰å…¨å•é¡Œ**ï¼šå¦‚æœ Service æœ‰ç‹€æ…‹æœƒæœ‰ç«¶çˆ­
- âŒ **æ¶æ§‹è¤‡é›œåº¦**ï¼šé•å Clean Architecture åŸå‰‡
- âŒ **é›£ä»¥æ¸¬è©¦**ï¼šå…¨å±€ç‹€æ…‹é›£ä»¥éš”é›¢

**çµè«–ï¼šService å±¤ä¸é©åˆå–®ä¾‹æ¨¡å¼ï¼**

---

## äº”ã€FastAPI çš„ä¾è³´å¿«å–æ©Ÿåˆ¶

### FastAPI çš„è«‹æ±‚ç´šå¿«å–

```python
# åŒä¸€å€‹è«‹æ±‚ä¸­ï¼Œç›¸åŒçš„ä¾è³´åªå‰µå»ºä¸€æ¬¡
@router.get("/complex")
def complex_endpoint(
    service1: CartService = Depends(get_cart_service),
    service2: CartService = Depends(get_cart_service),  # â† é‡ç”¨ service1
):
    # service1 is service2  # Trueï¼ˆåŒä¸€å€‹å¯¦ä¾‹ï¼‰
    pass
```

**ç‰¹é»ï¼š**
- âœ… åŒä¸€è«‹æ±‚å…§ï¼Œä¾è³´åªå‰µå»ºä¸€æ¬¡
- âŒ ä¸åŒè«‹æ±‚ä¹‹é–“ï¼Œä¾è³´ä¸å…±äº«

**é€™å·²ç¶“æ˜¯æœ€ä½³å¯¦è¸ï¼**

---

## å…­ã€å¯¦éš›æ€§èƒ½ç“¶é ¸åˆ†æ

### å°è±¡å‰µå»ºé–‹éŠ·æ’åºï¼ˆå¾å¤§åˆ°å°ï¼‰

| åºè™Ÿ | æ“ä½œ | å…¸å‹è€—æ™‚ | å½±éŸ¿ç¨‹åº¦ |
|-----|------|---------|---------|
| 1 | ğŸ”´ è³‡æ–™åº«æŸ¥è©¢ | 1-100ms | **æœ€å¤§ç“¶é ¸** |
| 2 | ğŸŸ  ç¶²çµ¡ I/O | 1-10ms | **ç¬¬äºŒç“¶é ¸** |
| 3 | ğŸŸ¡ Session ç®¡ç† | 10-100Î¼s | éœ€è¦é—œæ³¨ |
| 4 | ğŸŸ¢ GC åœé “ | ~1Î¼sï¼ˆåˆ†æ”¤ï¼‰ | é«˜ QPS ä¸‹é¡¯ç¾ |
| 5 | âœ… å°è±¡å‰µå»º | 0.1Î¼s | **å¯å¿½ç•¥** |

### Python å°è±¡å‰µå»ºçš„æˆæœ¬

```python
# ç°¡å–®å°è±¡å‰µå»º
class CartService:
    def __init__(self, cart_repo):
        self.cart_repo = cart_repo

# å‰µå»ºæ™‚é–“ï¼šç´„ 0.1 å¾®ç§’ï¼ˆ100 ç´ç§’ï¼‰

# 1000 QPS çš„å‰µå»ºé–‹éŠ·
1000 è«‹æ±‚ Ã— 4 å€‹å°è±¡ Ã— 0.1 å¾®ç§’ = 0.4 æ¯«ç§’/ç§’

# ç›¸å°æ–¼è³‡æ–™åº«æŸ¥è©¢ï¼ˆé€šå¸¸ 1-100msï¼‰ï¼Œé€™æ˜¯å¯å¿½ç•¥çš„
```

**çµè«–ï¼šâœ… å°è±¡å‰µå»ºæœ¬èº«ä¸æ˜¯ç“¶é ¸**

---

## ä¸ƒã€ä¸åŒ QPS å ´æ™¯ä¸‹çš„æ€§èƒ½è©•ä¼°

### QPS < 100 âœ… å®Œå…¨æ²’å•é¡Œ

```
å°è±¡å‰µå»º: å¯å¿½ç•¥ï¼ˆ< 0.04ms/ç§’ï¼‰
GC å£“åŠ›: æ¥µä½ï¼ˆ< 1 æ¬¡/ç§’ï¼‰
è¨˜æ†¶é«”: ç„¡å•é¡Œï¼ˆ< 350KBï¼‰

çµè«–ï¼šå®Œå…¨ä¸éœ€è¦æ“”å¿ƒ
```

### QPS 100-1000 ğŸŸ¡ å¯ä»¥æ¥å—

```
å°è±¡å‰µå»º: ä»ç„¶å¯å¿½ç•¥ï¼ˆ< 0.4ms/ç§’ï¼‰
GC å£“åŠ›: é–‹å§‹é¡¯ç¾ï¼ˆ1-11 æ¬¡/ç§’ï¼‰
è¨˜æ†¶é«”: ç„¡å•é¡Œï¼ˆ< 3.5MBï¼‰
P99 å»¶é²: å¯èƒ½å— GC å½±éŸ¿ 1-5ms

çµè«–ï¼šå¯ä»¥æ¥å—ï¼Œå»ºè­°é–‹å§‹ç›£æ§
```

### QPS 1000-5000 ğŸŸ  éœ€è¦é—œæ³¨

```
å°è±¡å‰µå»º: å¯å¿½ç•¥ï¼ˆ< 2ms/ç§’ï¼‰
GC å£“åŠ›: æ˜é¡¯ï¼ˆ11-55 æ¬¡/ç§’ï¼‰
è¨˜æ†¶é«”: å¯èƒ½æœ‰å£“åŠ›ï¼ˆå¦‚æœè«‹æ±‚è™•ç†æ…¢ï¼‰
P99 å»¶é²: æœƒå— GC å½±éŸ¿ 5-20ms

çµè«–ï¼šéœ€è¦ç›£æ§å’Œå„ªåŒ–
å„ªåŒ–æ–¹å‘ï¼š
1. è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–
2. é€£æ¥æ± é…ç½®
3. è€ƒæ…®æ°´å¹³æ“´å±•
```

### QPS > 5000 ğŸ”´ éœ€è¦å„ªåŒ–

```
å°è±¡å‰µå»º: é–‹å§‹æœ‰å½±éŸ¿ï¼ˆ> 2ms/ç§’ï¼‰
GC å£“åŠ›: åš´é‡ï¼ˆ> 55 æ¬¡/ç§’ï¼‰
è¨˜æ†¶é«”: å¯èƒ½æœ‰å•é¡Œ
P99 å»¶é²: æ˜é¡¯å—å½±éŸ¿ï¼ˆ> 20msï¼‰

çµè«–ï¼šå¿…é ˆå„ªåŒ–
å„ªåŒ–ç­–ç•¥ï¼š
1. æ°´å¹³æ“´å±•ï¼ˆå¤šå€‹å¯¦ä¾‹ï¼‰â† æœ€å„ªå…ˆ
2. å°è±¡æ± æ¨¡å¼
3. èª¿æ•´ GC åƒæ•¸
4. å¼•å…¥å¿«å–
```

---

## å…«ã€çœŸæ­£çš„ç“¶é ¸åœ¨å“ªè£¡ï¼Ÿ

### Session ç®¡ç†æ‰æ˜¯æ›´é—œéµçš„å•é¡Œ

```python
# æ¯æ¬¡è«‹æ±‚å‰µå»º Session
def get_session():
    session = SessionLocal()  # å¾é€£æ¥æ± ç²å–
    try:
        yield session
    finally:
        session.close()  # è¿”å›é€£æ¥æ± 
```

**Session çš„é–‹éŠ·ï¼š**
- Session å‰µå»ºï¼šç´„ 10 å¾®ç§’
- å¾é€£æ¥æ± ç²å–é€£æ¥ï¼šå¯èƒ½éœ€è¦ç­‰å¾…
- **é€£æ¥æ± è€—ç›¡æœƒå°è‡´è«‹æ±‚é˜»å¡** â† æ›´å¤§çš„å•é¡Œ

**å„ªå…ˆå„ªåŒ–æ–¹å‘ï¼š**
1. ğŸ”´ **é€£æ¥æ± é…ç½®**ï¼ˆpool_size, max_overflowï¼‰
2. ğŸ”´ **è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–**ï¼ˆç´¢å¼•ã€æŸ¥è©¢è¨ˆåŠƒï¼‰
3. ğŸŸ  **å¿«å–ç­–ç•¥**ï¼ˆRedisï¼‰
4. ğŸŸ¡ GC èª¿å„ª
5. âœ… å°è±¡å‰µå»ºï¼ˆä¸éœ€è¦å„ªåŒ–ï¼‰

---

## ä¹ã€å„ªåŒ–ç­–ç•¥å»ºè­°

### éšæ®µ 1ï¼šç•¶å‰éšæ®µï¼ˆQPS < 1000ï¼‰âœ…

**ç­–ç•¥ï¼šä¿æŒç•¶å‰æ¶æ§‹ä¸è®Š**

**åŸå› ï¼š**
- å°è±¡å‰µå»ºé–‹éŠ·å¯å¿½ç•¥
- GC å£“åŠ›å°šå¯æ¥å—
- æ¶æ§‹æ¸…æ™°ï¼Œæ˜“æ–¼ç¶­è­·

**æ‡‰è©²åšçš„ï¼š**
1. âœ… **æ·»åŠ ç›£æ§æŒ‡æ¨™**
   ```python
   # ç›£æ§ GC çµ±è¨ˆ
   import gc
   gc.get_stats()
   
   # ç›£æ§è¨˜æ†¶é«”ä½¿ç”¨
   import tracemalloc
   tracemalloc.start()
   
   # ç›£æ§è«‹æ±‚å»¶é²
   # P50, P95, P99 å»¶é²
   ```

2. âœ… **å„ªåŒ–è³‡æ–™åº«æŸ¥è©¢**
   - æ·»åŠ ç´¢å¼•
   - å„ªåŒ–æŸ¥è©¢è¨ˆåŠƒ
   - ä½¿ç”¨ explain åˆ†æ

3. âœ… **é…ç½®é€£æ¥æ± **
   ```python
   engine = create_engine(
       DATABASE_URL,
       pool_size=20,        # é€£æ¥æ± å¤§å°
       max_overflow=10,     # æœ€å¤§æº¢å‡ºé€£æ¥
       pool_pre_ping=True,  # é€£æ¥å¥åº·æª¢æŸ¥
   )
   ```

### éšæ®µ 2ï¼šGC å„ªåŒ–ï¼ˆQPS > 1000ï¼‰

**é¸é … 1ï¼šèª¿æ•´ GC é–¾å€¼**

```python
import gc

# æ¸›å°‘ GC é »ç‡ï¼ˆæœƒå¢åŠ å–®æ¬¡ GC æ™‚é–“ï¼‰
gc.set_threshold(1000, 15, 15)  # é»˜èªæ˜¯ (700, 10, 10)

# æˆ–è€…ï¼šç¦ç”¨è‡ªå‹• GCï¼Œå®šæœŸæ‰‹å‹•è§¸ç™¼
gc.disable()
# åœ¨è«‹æ±‚è™•ç†çš„ç©ºé–’æ™‚é–“æ‰‹å‹•è§¸ç™¼
gc.collect()
```

**å„ªé»ï¼š**
- âœ… ç°¡å–®ï¼Œåªéœ€èª¿æ•´åƒæ•¸
- âœ… æ¸›å°‘ GC é »ç‡

**ç¼ºé»ï¼š**
- âš ï¸ å–®æ¬¡ GC æ™‚é–“æœƒå¢åŠ 
- âš ï¸ è¨˜æ†¶é«”å£“åŠ›æœƒå¢å¤§

**é¸é … 2ï¼šå°è±¡æ± æ¨¡å¼**

```python
# ç‚º Repository å¯¦ä¾‹å»ºç«‹å°è±¡æ± 
from queue import Queue

class RepositoryPool:
    def __init__(self, repo_class, size=10):
        self.pool = Queue(maxsize=size)
        for _ in range(size):
            self.pool.put(repo_class())
    
    def acquire(self):
        return self.pool.get()
    
    def release(self, repo):
        self.pool.put(repo)
```

**å„ªé»ï¼š**
- âœ… æ¸›å°‘å°è±¡å‰µå»º
- âœ… æ¸›å°‘ GC å£“åŠ›

**ç¼ºé»ï¼š**
- âŒ è¤‡é›œåº¦å¢åŠ 
- âŒ éœ€è¦è™•ç† Session ç”Ÿå‘½é€±æœŸ
- âŒ å¯èƒ½æœ‰ç·šç¨‹å®‰å…¨å•é¡Œ

### éšæ®µ 3ï¼šæ°´å¹³æ“´å±•ï¼ˆQPS > 3000ï¼‰â­ æ¨è–¦

**ç­–ç•¥ï¼šå¢åŠ æ‡‰ç”¨å¯¦ä¾‹æ•¸é‡**

```yaml
# docker-compose.yml
services:
  app1:
    environment:
      SERVICE_ROLE: api
    ports:
      - "8000:8000"
  
  app2:
    environment:
      SERVICE_ROLE: api
    ports:
      - "8001:8000"
  
  app3:
    environment:
      SERVICE_ROLE: api
    ports:
      - "8002:8000"
  
  nginx:
    # è² è¼‰å‡è¡¡
```

**å„ªé»ï¼š**
- âœ… **æœ€ä½³è§£æ±ºæ–¹æ¡ˆ**
- âœ… ç·šæ€§æ“´å±•èƒ½åŠ›
- âœ… é«˜å¯ç”¨æ€§
- âœ… ç„¡éœ€ä¿®æ”¹ä»£ç¢¼

**é€™æ¯”å„ªåŒ–å–®ä¾‹æ¨¡å¼æ›´é‡è¦ï¼**

---

## åã€ç›£æ§æŒ‡æ¨™

### éœ€è¦ç›£æ§çš„é—œéµæŒ‡æ¨™

#### 1. GC æŒ‡æ¨™

```python
import gc
import time

# ç›£æ§ GC çµ±è¨ˆ
def get_gc_stats():
    stats = gc.get_stats()
    return {
        'gen0_collections': stats[0]['collections'],
        'gen1_collections': stats[1]['collections'],
        'gen2_collections': stats[2]['collections'],
        'gen0_collected': stats[0]['collected'],
    }

# ç›£æ§ GC æ™‚é–“
gc_time_start = time.time()
gc.collect()
gc_time = time.time() - gc_time_start
```

#### 2. è¨˜æ†¶é«”æŒ‡æ¨™

```python
import tracemalloc

# å•Ÿå‹•è¨˜æ†¶é«”è¿½è¹¤
tracemalloc.start()

# ç²å–ç•¶å‰è¨˜æ†¶é«”ä½¿ç”¨
current, peak = tracemalloc.get_traced_memory()

# ç²å–å‰ 10 å€‹è¨˜æ†¶é«”ä½¿ç”¨æœ€å¤šçš„åœ°æ–¹
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')
```

#### 3. è«‹æ±‚å»¶é²æŒ‡æ¨™

```python
import time
from fastapi import Request

@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    
    # è¨˜éŒ„åˆ°ç›£æ§ç³»çµ±
    metrics.histogram('request_duration', process_time)
    
    return response
```

#### 4. å°è±¡å‰µå»ºè¨ˆæ•¸

```python
class ObjectCreationCounter:
    _counters = {}
    
    @classmethod
    def increment(cls, obj_type: str):
        cls._counters[obj_type] = cls._counters.get(obj_type, 0) + 1
    
    @classmethod
    def get_stats(cls):
        return cls._counters

# åœ¨ __init__ ä¸­èª¿ç”¨
class CartService:
    def __init__(self, cart_repo):
        ObjectCreationCounter.increment('CartService')
        self.cart_repo = cart_repo
```

---

## åä¸€ã€ç¸½çµ

### æ ¸å¿ƒçµè«–

#### 1. è¨˜æ†¶é«”å•é¡Œ ğŸŸ¢

**çµè«–ï¼šä¸éœ€è¦æ“”å¿ƒ**

- å–®å€‹è«‹æ±‚è¨˜æ†¶é«”ä½”ç”¨ï¼šç´„ 3.5KB
- 1000 QPS åŒæ™‚å­˜åœ¨çš„å°è±¡ï¼š< 3.5MB
- åªæœ‰åœ¨æ¥µé«˜ QPSï¼ˆ> 10000ï¼‰ä¸”è«‹æ±‚è™•ç†æ…¢ï¼ˆ> 1sï¼‰æ™‚æ‰å¯èƒ½æœ‰å•é¡Œ

#### 2. GC å£“åŠ› ğŸŸ¡

**çµè«–ï¼šä¸­ç­‰ QPS ä¸‹éœ€è¦é—œæ³¨**

| QPS ç¯„åœ | GC å½±éŸ¿ | å»ºè­° |
|---------|--------|------|
| < 100 | å¯å¿½ç•¥ | ç„¡éœ€æ“”å¿ƒ |
| 100-1000 | è¼•å¾® | é–‹å§‹ç›£æ§ |
| 1000-5000 | æ˜é¡¯ | å„ªåŒ–æˆ–æ“´å±• |
| > 5000 | åš´é‡ | å¿…é ˆæ“´å±• |

#### 3. å°è±¡å‰µå»ºé–‹éŠ· âœ…

**çµè«–ï¼šå®Œå…¨ä¸éœ€è¦æ“”å¿ƒ**

- å–®å€‹å°è±¡å‰µå»ºï¼šç´„ 0.1 å¾®ç§’
- ç›¸å°æ–¼è³‡æ–™åº«æŸ¥è©¢ï¼ˆ1-100msï¼‰ï¼Œå¯å®Œå…¨å¿½ç•¥

### æ˜¯å¦éœ€è¦å–®ä¾‹æ¨¡å¼ï¼Ÿ

**ç­”æ¡ˆï¼šä¸éœ€è¦ï¼**

**åŸå› ï¼š**
1. âŒ Service ä¾è³´ Sessionï¼Œç„¡æ³•è·¨è«‹æ±‚å…±äº«
2. âŒ æœƒç ´å£æ¶æ§‹çš„æ¸…æ™°æ€§
3. âŒ æœƒå¼•å…¥ç·šç¨‹å®‰å…¨å•é¡Œ
4. âŒ æ”¶ç›Šé å°æ–¼æ¶æ§‹è¤‡é›œåº¦å¢åŠ çš„æˆæœ¬

**æ­£ç¢ºçš„å„ªåŒ–æ–¹å‘ï¼š**
1. â­ **æ°´å¹³æ“´å±•**ï¼ˆå¢åŠ å¯¦ä¾‹æ•¸é‡ï¼‰
2. ğŸ”´ **è³‡æ–™åº«å„ªåŒ–**ï¼ˆç´¢å¼•ã€æŸ¥è©¢è¨ˆåŠƒï¼‰
3. ğŸŸ  **å¿«å–ç­–ç•¥**ï¼ˆRedisï¼‰
4. ğŸŸ¡ **é€£æ¥æ± é…ç½®**
5. ğŸŸ¢ GC èª¿å„ªï¼ˆå¦‚æœç¢ºå¯¦æœ‰å•é¡Œï¼‰

### æœ€é‡è¦çš„èªçŸ¥

**åœ¨ç¾ä»£å¾®æœå‹™æ¶æ§‹ä¸­ï¼š**

```
æ°´å¹³æ“´å±•ï¼ˆScale Outï¼‰> å‚ç›´å„ªåŒ–ï¼ˆScale Upï¼‰

å¢åŠ å¯¦ä¾‹ > å–®ä¾‹æ¨¡å¼å„ªåŒ–
```

**æ‚¨çš„æ¶æ§‹è¨­è¨ˆæ˜¯åˆç†çš„ï¼š**
- âœ… ç¬¦åˆ Clean Architecture åŸå‰‡
- âœ… ä»£ç¢¼æ¸…æ™°æ˜“ç¶­è­·
- âœ… æ˜“æ–¼æ¸¬è©¦
- âœ… åœ¨ä¸­ä½ QPS ä¸‹æ€§èƒ½è¶³å¤ 

**ä¸è¦ç‚ºäº†ã€Œå¯èƒ½çš„å•é¡Œã€è€ŒçŠ§ç‰²æ¶æ§‹çš„æ¸…æ™°æ€§å’Œå¯ç¶­è­·æ€§ï¼**

---

## åäºŒã€å¯¦æˆ°å»ºè­°

### ç«‹å³å¯åšçš„äº‹æƒ…ï¼ˆå„ªå…ˆç´šæ’åºï¼‰

#### Priority 1ï¼šæ·»åŠ ç›£æ§ ğŸ”´

```python
# 1. æ·»åŠ è«‹æ±‚å»¶é²ç›£æ§
# 2. æ·»åŠ  GC çµ±è¨ˆç›£æ§
# 3. æ·»åŠ è¨˜æ†¶é«”ä½¿ç”¨ç›£æ§
# 4. è¨­ç½®å‘Šè­¦é–¾å€¼
```

#### Priority 2ï¼šè³‡æ–™åº«å„ªåŒ– ğŸ”´

```python
# 1. æª¢æŸ¥æ…¢æŸ¥è©¢æ—¥èªŒ
# 2. æ·»åŠ å¿…è¦çš„ç´¢å¼•
# 3. å„ªåŒ– N+1 æŸ¥è©¢å•é¡Œ
# 4. ä½¿ç”¨ explain åˆ†ææŸ¥è©¢è¨ˆåŠƒ
```

#### Priority 3ï¼šé€£æ¥æ± é…ç½® ğŸŸ 

```python
# 1. æ ¹æ“šä½µç™¼é‡èª¿æ•´ pool_size
# 2. é…ç½® max_overflow
# 3. å•Ÿç”¨ pool_pre_ping
```

#### Priority 4ï¼šå£“åŠ›æ¸¬è©¦ ğŸŸ¡

```bash
# ä½¿ç”¨ locust æˆ– k6 é€²è¡Œå£“åŠ›æ¸¬è©¦
# æ‰¾å‡ºçœŸæ­£çš„ç“¶é ¸
```

#### Priority 5ï¼šGC èª¿å„ª ğŸŸ¢

```python
# åªæœ‰åœ¨ç›£æ§é¡¯ç¤º GC ç¢ºå¯¦æ˜¯ç“¶é ¸æ™‚æ‰åš
```

### ä¸è¦åšçš„äº‹æƒ… âŒ

1. âŒ ä¸è¦å¼•å…¥å–®ä¾‹æ¨¡å¼
2. âŒ ä¸è¦éæ—©å„ªåŒ–
3. âŒ ä¸è¦åœ¨æ²’æœ‰æ•¸æ“šæ”¯æŒçš„æƒ…æ³ä¸‹å„ªåŒ–
4. âŒ ä¸è¦çŠ§ç‰²æ¶æ§‹æ¸…æ™°æ€§ä¾†æ›å–å¾®å°çš„æ€§èƒ½æå‡

---

## ç›¸é—œæ–‡æª”

- [ä¾è³´æ³¨å…¥æµç¨‹è©³è§£.md](./ä¾è³´æ³¨å…¥æµç¨‹è©³è§£.md)
- [Wiring æ¨¡çµ„-è‡ªå‹•åŒ–ä¾è³´æ³¨å…¥.md](./Wiring%20æ¨¡çµ„-è‡ªå‹•åŒ–ä¾è³´æ³¨å…¥.md)
- [Clean Architecture åŒå¿ƒåœ“æ¶æ§‹è©³è§£.md](./Clean%20Architecture%20åŒå¿ƒåœ“æ¶æ§‹è©³è§£.md)
- [æ¶æ§‹èªªæ˜.md](./æ¶æ§‹èªªæ˜.md)

---

## åƒè€ƒè³‡æ–™

### Python GC ç›¸é—œ

- [Python GC Module Documentation](https://docs.python.org/3/library/gc.html)
- [Python Memory Management](https://docs.python.org/3/c-api/memory.html)

### æ€§èƒ½å„ªåŒ–ç›¸é—œ

- [FastAPI Performance Tips](https://fastapi.tiangolo.com/deployment/concepts/)
- [SQLAlchemy Connection Pooling](https://docs.sqlalchemy.org/en/14/core/pooling.html)

### æ¶æ§‹è¨­è¨ˆç›¸é—œ

- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Dependency Injection](https://en.wikipedia.org/wiki/Dependency_injection)

