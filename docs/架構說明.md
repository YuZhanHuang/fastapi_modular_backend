# 設計說明

## 1. core/ - 純業務邏輯（Core Layer）

### 1.1 core/domain/

#### 角色

定義系統領域模型（Domain Model）與商業規則。

例如：Cart, CartItem 及其行為（加商品、計算總金額、不變條件檢查）。

#### 允許

- 使用標準庫
- 依賴其他 core/domain 模型

#### 不允許

- 不依賴 core/services / core/repositories / core/ports
- 不依賴 infra/*
- 不操作資料庫、不呼叫 HTTP、不用 Redis、Celery 等

#### 被誰使用

- core/services
- core/repositories / core/ports
- 上層 Adapter 間接透過 services 使用

---

### 1.2 core/services/

#### 角色

負責「用例（Use Cases）」與應用流程。

把多個 Domain Model + 抽象介面（repositories/ports）串起來，完成一個完整操作。

例如：CartService.add_item(user_id, product_id, quantity)：

1. 查詢商品
2. 載入購物車
3. 呼叫 Cart.add_item(...)
4. 透過 Repository 儲存

#### 允許

依賴：

- core/domain
- core/repositories（介面）
- core/ports（介面）
- 標準庫

#### 不允許

- 不直接使用 ORM / SQL / Redis / HTTP client / Celery
- 不依賴 infra/*
- 不實作低階技術細節

#### 被誰使用

- api（HTTP endpoints）
- cli（命令列工具）
- worker（背景任務）
- 測試程式（unit / BDD）直接呼叫

---

### 1.3 core/repositories/

#### 角色

宣告「資料存取」的抽象介面（Ports）。

例如：CartRepository：

- `get_by_user_id(user_id) -> Cart | None`
- `save(cart: Cart) -> None`

#### 允許

- 依賴 core/domain
- 使用標準庫

#### 不允許

- 不寫任何 SQL / ORM
- 不依賴 infra/*
- 不放具體實作（SqlAlchemy* 不應在這出現）

#### 被誰使用

- core/services 利用它來存取資料
- infra/db/repositories 實作這些介面

---

### 1.4 core/ports/

#### 角色

宣告「外部系統 / 外部服務」的抽象介面（Ports）。

例如：外部錢包查詢、第三方支付、訊息推播、通知服務等。

**命名說明：**

使用 `core/ports/` 符合 Hexagonal Architecture（Ports and Adapters）標準術語：

- **Ports** = 接口定義（抽象），位於 core 層
- **Adapters** = 接口實作（具體），位於 infra 層

**建議的目錄結構：**

```
core/
├── domain/          # 領域模型
├── services/        # 用例實作
├── repositories/    # 資料存取 Ports
└── ports/           # 外部服務 Ports
    ├── payment_port.py      # 支付服務 Port
    ├── notification_port.py # 通知服務 Port
    └── external_api_port.py # 外部 API Port
```

#### 允許

- 依賴 core/domain 或自定義 DTO
- 使用標準庫

#### 不允許

- 不依賴 infra/*
- 不使用 HTTP client / SDK
- 不寫具體呼叫邏輯

#### 被誰使用

- core/services：透過 port 抽象使用外部能力
- infra/adapters：實作這些介面

---

## 2. infra/ - 技術實作層（Infrastructure Layer）

### 整體角色

實作 core/repositories 與 core/ports 定義的介面。

專責處理資料庫、快取、佇列、外部 API 等技術細節。

不主導業務流程，只提供能力。

#### 允許

依賴：

- core/domain
- core/repositories
- core/ports
- ORM（如 SQLAlchemy）
- Redis client、HTTP client、MQ SDK 等

#### 不允許

- 不被 core/* 反向引用
- 不實作高階業務規則（那是 core 的職責）
- 不作為對外入口（不直接處理 HTTP/CLI）

---

### 2.1 infra/db/models/

#### 角色

定義 ORM Model 與資料表結構。

負責映射到底層資料庫（PostgreSQL、MySQL 等）。

#### 允許

- 依賴 ORM / infra/db/base.py

#### 不允許

- 不包含業務邏輯
- 不依賴 core/services

#### 被誰使用

- infra/db/repositories
- migration 工具（Alembic）

---

### 2.2 infra/db/repositories/

#### 角色

具體實作 core/repositories 的介面。

使用 ORM / SQL 讀寫 infra/db/models。

實作類別使用多重繼承：

- 繼承 SqlAlchemyRepositoryBase（通用 CRUD 基類）
- 繼承 core/repositories 定義的介面

例如：`CartRepositoryImpl(SqlAlchemyRepositoryBase, CartRepository)`

#### 允許

依賴：

- core/domain
- core/repositories
- infra/db/models
- ORM / DB client
- infra/db/repositories/base_repository（通用 CRUD 基類）

#### 不允許

- 不依賴 core/services
- 不實作流程型業務邏輯（僅做資料存取與轉換）

#### 被誰使用

- 在 infra/wiring.py 中被組裝進 core/services
- 間接被 API / CLI / Worker 透過 services 使用

---

### 2.2.1 infra/db/repositories/base_repository.py

#### 角色

提供通用 CRUD 操作基類（SqlAlchemyRepositoryBase）。

封裝常見的 SQLAlchemy ORM 操作，參考 Django ORM 設計風格。

提供方法包括：

- `save()` / `save_all()` - 保存模型
- `get()` / `get_or_404()` - 根據主鍵查詢
- `first()` / `last()` - 查詢第一/最後一筆
- `find()` - 返回 Query 物件（可鏈式調用）
- `exists()` / `count()` - 檢查存在性與統計
- `create()` / `update()` / `delete()` - CRUD 操作
- `get_or_create()` - 取得或創建
- `delete_by()` - 根據條件批量刪除

#### 允許

- 依賴 SQLAlchemy ORM
- 使用注入的 Session（非全局 db 物件）

#### 不允許

- 不包含業務邏輯
- 不依賴 core/services

#### 被誰使用

- infra/db/repositories/*_impl.py 實作類別繼承此基類

---

### 2.3 infra/adapters/（如有）

#### 角色

實作 core/ports 的介面。

負責與外部系統、第三方服務溝通（HTTP、gRPC、SDK）。

**命名說明：**

使用 `infra/adapters/` 符合 Hexagonal Architecture 標準：

- **Ports**（在 core 層）= 接口定義（抽象）
- **Adapters**（在 infra 層）= 接口實作（具體）

**推薦結構：**

```
infra/
├── db/
│   └── repositories/  # 資料存取 Adapters
└── adapters/          # 外部服務 Adapters
    ├── payment/      # 支付服務 Adapter
    │   └── stripe_adapter.py
    ├── notification/ # 通知服務 Adapter
    │   └── email_adapter.py
    └── external_api/ # 外部 API Adapter
```

#### 允許

依賴：

- core/ports
- core/domain（用於輸出輸入結構）
- HTTP / gRPC / SDK clients

#### 不允許

- 不實作高階業務決策
- 不被 core 反向依賴

#### 被誰使用

- infra/wiring.py 組裝到 core/services
- 由 API / Worker 透過 services 間接使用

**範例：**

```python
# core/ports/payment_port.py
class PaymentPort(ABC):
    @abstractmethod
    def process_payment(self, amount: int) -> PaymentResult:
        pass

# infra/adapters/payment/stripe_adapter.py
class StripePaymentAdapter(PaymentPort):
    def process_payment(self, amount: int) -> PaymentResult:
        # 實作 Stripe 支付邏輯
        pass
```

---

### 2.4 infra/wiring.py

#### 角色

Composition Root / 組裝工廠。

負責把「抽象」與「實作」對應起來，提供統一建構方式。

#### 內容示例

定義：

- `create_cart_repository(session) -> CartRepository`
- `create_cart_service(session) -> CartService`

由 API / CLI / Worker 呼叫，用於依賴注入。

#### 允許

依賴：

- core/services
- core/repositories / core/ports
- infra/db.repositories / infra/adapters 等實作

#### 不允許

- 不包含業務流程邏輯
- 不作為對外入口

---

## 3. application/ - 應用層（Application Layer）

### 角色

應用程式初始化與組件組裝層。

負責：

- 初始化基礎設施（資料庫、Redis 等）
- 組裝應用程式組件
- 創建並配置 FastAPI 應用實例
- 提供 ASGI callable object（用於 uvicorn 等 ASGI 伺服器）

#### 允許

依賴：

- api/http_app（HTTP 層配置）
- infra/db（資料庫初始化，僅開發環境）
- 標準庫
- 環境變數（用於判斷環境）

#### 不允許

- 不包含業務邏輯
- 不直接處理 HTTP 請求（那是 api 層的職責）
- 不實作資料存取邏輯（那是 infra 層的職責）

#### 被誰使用

- ASGI 伺服器（uvicorn）作為應用入口點
- Docker entrypoint.sh 啟動服務時引用

---

### 3.1 application/app.py

#### 角色

應用程式初始化入口。

提供 `create_app()` 函數，可控制資料庫初始化行為。

提供 `app` 作為 ASGI callable object。

資料庫初始化策略：

- 生產環境：使用 Alembic migrations（在 entrypoint.sh 中執行）
- 開發環境：可選的資料庫初始化（透過環境變數控制）

#### 允許

- 呼叫 `api/http_app.create_http_app()` 創建 FastAPI 應用
- 根據環境變數決定是否初始化資料庫

#### 不允許

- 不直接註冊路由（路由註冊在 api/http_app.py）
- 不包含 HTTP 處理邏輯

#### 被誰使用

- uvicorn 等 ASGI 伺服器
- Docker entrypoint.sh 中的啟動命令

---

## 4. api/ - HTTP 介面層（Adapters）

### 角色

提供 RESTful API。

負責：

- 解析 HTTP 請求 / 驗證輸入
- 呼叫 core.services 完成用例
- 回傳適當的 HTTP 回應（JSON / 狀態碼）

#### 允許

依賴：

- FastAPI / Pydantic
- infra.wiring（取得 service 實例）
- core.services（作為注入型別）

#### 不允許

- 不直接寫 SQL / ORM / HTTP 外部呼叫
- 不在這裡實作主要業務流程（流程留給 services）
- 不初始化資料庫（應在 application 層處理）

---

### 4.1 api/http_app.py

#### 角色

只負責 FastAPI 應用程式的 HTTP 相關配置。

包括：

- FastAPI 應用實例創建
- 路由註冊
- Middleware 配置（如有）
- CORS 配置（如有）

不包含：

- 資料庫初始化（應在 application 層處理）
- 業務邏輯（應在服務層處理）

#### 允許

- 註冊路由（`app.include_router`）
- 配置 FastAPI 應用（title、version 等）

#### 不允許

- 不初始化資料庫（`Base.metadata.create_all`）
- 不直接操作資料庫
- 不包含業務邏輯

#### 被誰使用

- application/app.py 呼叫 `create_http_app()`

---

### 4.2 api/deps.py

#### 角色

定義 FastAPI 的依賴注入函數。

提供 `get_*_service()` 等依賴函數，用於在路由中注入服務。

#### 允許

- 依賴 infra.wiring（取得 service 實例）
- 使用 FastAPI Depends

#### 不允許

- 不直接操作資料庫
- 不包含業務邏輯

#### 被誰使用

- api/v1/*.py 路由處理函數透過 `Depends()` 使用

---

### 4.3 api/v1/

#### 角色

定義具體的 HTTP 端點（Endpoints）。

每個檔案對應一個資源或功能模組。

#### 允許

- 定義路由處理函數
- 使用 Pydantic 模型進行請求/回應驗證
- 透過 `Depends()` 注入服務

#### 不允許

- 不直接操作資料庫
- 不實作業務流程（委託給 services）

---

## 5. cli/ - 命令列介面層（Adapters）

### 角色

提供命令列操作入口（維運指令、管理指令）。

與 API 一樣，呼叫 core.services 完成工作。

#### 允許

- 依賴 CLI 框架（如 Typer / Click）
- 依賴 infra.wiring、core.services

#### 不允許

- 不直接操作 DB / 外部服務，不重複寫業務邏輯

---

## 6. worker/ - 背景任務層（Adapters）

### 角色

Celery / RQ 等 worker 的任務執行端。

任務內容應盡量呼叫 core.services，保持與 API 同一邏輯。

#### 允許

依賴：

- 任務框架（Celery 等）
- infra.wiring
- core.services

#### 不允許

- 不在任務中直接散寫流程邏輯，避免與 services 分岔

---

## 7. tests/ - 測試層

### 角色

針對不同層級設計測試：

- **unit/**：優先測 core（domain + services）
- **integration/**：測 infra 實作與 DB/外部服務整合
- **bdd/**：從使用者行為角度驗證完整流程

### 規範

- 測試可以跨層引用，只要清楚測試目標
- 優先保證 core 的穩定與正確，降低 refactor 成本

---

## 8. 架構層級關係圖

```
┌─────────────────────────────────────────┐
│         ASGI Server (uvicorn)           │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      application/app.py                 │
│      (應用層 - 初始化與組裝)              │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      api/http_app.py                     │
│      (HTTP 層 - FastAPI 配置)            │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      api/v1/*.py                        │
│      (HTTP 端點 - 路由處理)                │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      core/services/                     │
│      (業務邏輯層 - 用例實作)              │
└───────┬───────────────────┬─────────────┘
        │                   │
        ▼                   ▼
┌──────────────┐   ┌──────────────────┐
│ core/domain/ │   │ core/repositories│
│ (領域模型)    │   │ (抽象介面)        │
└──────────────┘   └────────┬─────────┘
                            │
                            ▼
┌─────────────────────────────────────────┐
│      infra/db/repositories/*_impl.py     │
│      (實作層 - 資料存取)                   │
│      ├─ SqlAlchemyRepositoryBase        │
│      └─ CartRepositoryImpl               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      infra/db/models/                    │
│      (ORM 模型)                          │
└─────────────────────────────────────────┘
```

---

## 9. 依賴方向原則

**核心原則：依賴方向永遠指向核心（core）**

- `core/` 不依賴 `infra/`、`api/`、`application/`
- `infra/` 實作 `core/` 定義的介面
- `api/`、`cli/`、`worker/` 透過 `application/` 或直接使用 `core/services`
- `application/` 組裝各層，但不包含業務邏輯

---

## 10. 命名規範

### 10.1 Repository 實作類別

**命名格式：** `{Entity}RepositoryImpl`

**例如：** `CartRepositoryImpl`

不使用技術前綴（如 `SqlAlchemyCartRepository`），因為：

- 明確表示這是實作層（Impl = Implementation）
- 技術中立，不綁定特定 ORM 框架
- 與檔案名稱一致（`cart_repository_impl.py`）

### 10.2 通用基類

`infra/db/repositories/base_repository.py` 提供 `SqlAlchemyRepositoryBase`

實作類別使用多重繼承：

```python
class CartRepositoryImpl(SqlAlchemyRepositoryBase, CartRepository):
    pass
```

### 10.3 外部服務接口命名

**使用：** `core/ports/` + `infra/adapters/`

**理由：**

1. 符合 Hexagonal Architecture 標準術語
2. 與 `core/repositories/` 命名一致（都是 Ports）
3. 語義清晰，避免與其他概念混淆

**範例結構：**

```
core/
├── ports/
│   ├── payment_port.py      # PaymentPort
│   └── notification_port.py # NotificationPort

infra/
└── adapters/
    ├── payment/
    │   └── stripe_adapter.py # StripePaymentAdapter
    └── notification/
        └── email_adapter.py  # EmailNotificationAdapter
```

---

## 11. 啟動流程

### 11.1 Docker 環境

1. `entrypoint.sh` 執行
2. 等待資料庫/Redis 就緒
3. 執行 Alembic migrations（生產環境）
4. 啟動服務：
   - API: `uvicorn app.application.app:app`
   - Worker: `celery -A app.worker.celery_app.celery worker`
   - Beat: `celery -A app.worker.celery_app.celery beat`

### 11.2 應用初始化流程

1. `application/app.py` 的 `app` 物件被載入
2. `create_app()` 被呼叫（預設不初始化資料庫）
3. `create_http_app()` 被呼叫，創建 FastAPI 應用
4. 路由被註冊到 FastAPI 應用
5. ASGI 伺服器開始處理請求

---

## 12. 資料庫管理

### 12.1 生產環境

使用 Alembic migrations：

- migrations 腳本位於 `infra/db/migrations/versions/`
- `entrypoint.sh` 中執行 `alembic upgrade head`
- 不在應用程式啟動時創建資料表

### 12.2 開發環境

可選的資料庫初始化：

- 透過環境變數控制
- 僅在非生產環境且未執行 migrations 時初始化
- 使用 `Base.metadata.create_all()`（僅開發使用）

### 12.3 Alembic 配置

- `alembic.ini` 位於專案根目錄
- `script_location` 指向 `src/app/infra/db/migrations`
- `env.py` 使用 `app.config.settings.DATABASE_URL`
- `target_metadata` 使用 `app.infra.db.base.Base.metadata`

---

## 13. Clean Architecture 對比分析

### 13.1 什麼是 Clean Architecture？

Clean Architecture（潔淨架構）是由 Robert C. Martin（Uncle Bob）提出的架構設計原則，核心目標是：

1. **獨立性**：業務邏輯獨立於框架、UI、資料庫、外部服務
2. **可測試性**：業務邏輯可以在沒有 UI、資料庫、Web 伺服器的情況下測試
3. **可替換性**：可以輕鬆替換框架、資料庫、外部服務，而不影響業務邏輯
4. **依賴規則**：依賴方向永遠指向內層（核心）

#### Clean Architecture 的四層結構

```
┌─────────────────────────────────────────┐
│   Frameworks & Drivers (最外層)          │
│   - Web 框架、資料庫、UI、外部服務        │
└─────────────────┬───────────────────────┘
                  │ 依賴方向
                  ▼
┌─────────────────────────────────────────┐
│   Interface Adapters (介面適配層)        │
│   - Controllers、Presenters、Adapters   │
└─────────────────┬───────────────────────┘
                  │ 依賴方向
                  ▼
┌─────────────────────────────────────────┐
│   Use Cases (應用業務規則層)             │
│   - 用例實作、應用級業務邏輯              │
└─────────────────┬───────────────────────┘
                  │ 依賴方向
                  ▼
┌─────────────────────────────────────────┐
│   Entities (企業業務規則層 - 最內層)      │
│   - 領域模型、企業級業務規則              │
└─────────────────────────────────────────┘
```

#### 核心原則

1. **依賴規則（Dependency Rule）**
   - 依賴方向只能由外層指向內層
   - 內層不應該知道外層的任何事情
   - 內層定義接口（Ports），外層實作接口（Adapters）

2. **獨立性**
   - Entities：最純粹的業務規則，不依賴任何東西
   - Use Cases：應用級業務規則，只依賴 Entities
   - Interface Adapters：轉換層，將外部格式轉換為內部格式
   - Frameworks & Drivers：技術細節的實作

3. **可測試性**
   - 每一層都可以獨立測試
   - 不需要真實的資料庫、Web 伺服器就能測試業務邏輯

---

### 13.2 當前架構與 Clean Architecture 的對應關係

| Clean Architecture 層級 | 當前架構對應 | 說明 |
|-------------------------|------------|------|
| **Entities** | `core/domain/` | 領域模型與企業級業務規則 |
| **Use Cases** | `core/services/` | 用例實作與應用級業務邏輯 |
| **Ports (接口)** | `core/repositories/`<br>`core/ports/` | 定義抽象接口 |
| **Adapters (實作)** | `infra/db/repositories/`<br>`infra/adapters/` | 實作接口的技術細節 |
| **Interface Adapters** | `api/`<br>`cli/`<br>`worker/` | 將外部請求轉換為內部格式 |
| **Frameworks & Drivers** | FastAPI、SQLAlchemy、Redis、Celery | 框架與工具 |
| **Composition Root** | `application/app.py`<br>`infra/wiring.py` | 組裝各層的入口點 |

---

### 13.3 當前架構符合 Clean Architecture 的部分

#### ✅ 已實現的核心原則

1. **依賴方向正確**
   - `core/` 不依賴 `infra/`、`api/`、`application/`
   - `infra/` 實作 `core/` 定義的接口
   - 依賴方向指向核心

2. **業務邏輯獨立**
   - `core/domain/` 是純業務邏輯，不依賴任何技術框架
   - `core/services/` 只依賴領域模型和抽象接口
   - 可以獨立測試，不需要資料庫或 Web 框架

3. **接口與實作分離**
   - `core/repositories/` 定義接口（Ports）
   - `infra/db/repositories/` 實作接口（Adapters）
   - 可以輕鬆替換實作（如從 SQLAlchemy 換到 MongoDB）

4. **多個入口點**
   - `api/`、`cli/`、`worker/` 都是不同的 Interface Adapters
   - 都使用相同的 `core/services/`，保持業務邏輯一致

5. **Composition Root**
   - `infra/wiring.py` 負責組裝抽象與實作
   - `application/app.py` 負責應用程式初始化

---

### 13.4 當前架構與標準 Clean Architecture 的差異

#### 差異點分析

| 項目 | Clean Architecture 標準 | 當前架構 | 說明 |
|------|----------------------|---------|------|
| **DTO 位置** | Interface Adapters 層 | `api/v1/*.py` | ✅ 符合，DTO 在適配層 |
| **Entities 定義** | 最內層，純業務規則 | `core/domain/` | ✅ 符合 |
| **Use Cases 命名** | 通常以動詞命名（如 `AddItemToCart`） | `CartService.add_item()` | ⚠️ 可選：可考慮更明確的用例類別 |
| **輸入/輸出模型** | Interface Adapters 層定義 | `api/v1/` 中定義 | ✅ 符合 |
| **錯誤處理** | Use Cases 返回 Result 對象 | 使用 Exception | ⚠️ 可選：可考慮 Result 模式 |

#### 可選改進方向（非必須）

1. **更明確的 Use Cases 類別**
   ```python
   # 當前方式（也符合 Clean Architecture）
   class CartService:
       def add_item(...): ...
   
   # 可選：更明確的用例類別
   class AddItemToCartUseCase:
       def execute(...): ...
   ```
   **說明**：當前方式已經很好，Service 類別可以包含多個相關用例。

2. **Result 模式處理錯誤**
   ```python
   # 當前方式
   def add_item(...):
       if quantity <= 0:
           raise ValueError(...)
   
   # 可選：Result 模式
   def add_item(...) -> Result[Cart, Error]:
       if quantity <= 0:
           return Result.fail(Error("quantity must be positive"))
   ```
   **說明**：當前使用 Exception 已經足夠，Result 模式是進階選項。

3. **更明確的輸入/輸出模型分離**
   - 當前：DTO 在 `api/v1/` 中定義 ✅
   - 可選：考慮在 `api/dto/` 或 `api/schemas/` 中統一管理
   - **說明**：當前方式已經符合 Clean Architecture，分離是組織性改進

---

### 13.5 當前架構缺少的部分（評估）

#### ❌ 不缺少的部分（已符合 Clean Architecture）

1. ✅ **Entities 層** - `core/domain/` 已實現
2. ✅ **Use Cases 層** - `core/services/` 已實現
3. ✅ **Ports（接口）** - `core/repositories/`、`core/ports/` 已實現
4. ✅ **Adapters（實作）** - `infra/` 已實現
5. ✅ **Interface Adapters** - `api/`、`cli/`、`worker/` 已實現
6. ✅ **Composition Root** - `infra/wiring.py`、`application/app.py` 已實現
7. ✅ **依賴方向** - 已正確實現
8. ✅ **業務邏輯獨立性** - 已實現

#### ⚠️ 可選增強（非必須，視專案需求）

1. **DTO/Schema 層級分離**
   - 當前：DTO 定義在 `api/v1/carts.py` 中
   - 可選：建立 `api/schemas/` 或 `api/dto/` 統一管理
   - **評估**：小型專案當前方式已足夠，大型專案可考慮分離

2. **Use Case 類別化**
   - 當前：`CartService` 包含多個方法
   - 可選：每個用例一個類別（如 `AddItemToCartUseCase`）
   - **評估**：當前方式更簡潔，適合中小型專案

3. **錯誤處理標準化**
   - 當前：使用 Python Exception
   - 可選：Result 模式或 Domain Events
   - **評估**：當前方式已足夠，進階專案可考慮

4. **領域事件（Domain Events）**
   - 當前：未實現
   - 可選：用於解耦複雜業務流程
   - **評估**：視業務複雜度決定是否需要

---

### 13.6 總結

#### ✅ 當前架構符合 Clean Architecture 的核心原則

1. **依賴規則** ✅ - 依賴方向正確指向核心
2. **業務邏輯獨立** ✅ - `core/` 不依賴技術細節
3. **接口與實作分離** ✅ - Ports 和 Adapters 清晰分離
4. **可測試性** ✅ - 業務邏輯可獨立測試
5. **可替換性** ✅ - 可以輕鬆替換技術實作

#### 📊 架構完整度評估

| 層級 | 完整度 | 說明 |
|------|--------|------|
| Entities | ✅ 100% | `core/domain/` 完整實現 |
| Use Cases | ✅ 100% | `core/services/` 完整實現 |
| Ports | ✅ 100% | `core/repositories/`、`core/ports/` 完整實現 |
| Adapters | ✅ 100% | `infra/` 完整實現 |
| Interface Adapters | ✅ 100% | `api/`、`cli/`、`worker/` 完整實現 |
| Composition Root | ✅ 100% | `application/`、`infra/wiring.py` 完整實現 |

#### 🎯 結論

**當前架構已經完整實現 Clean Architecture 的核心原則**，沒有缺少必要的部分。

可選的增強項目（如 Result 模式、Domain Events、更細粒度的 Use Case 類別）是進階實踐，視專案規模和複雜度決定是否需要，並非 Clean Architecture 的必要組成部分。

當前架構設計已經：
- ✅ 符合 Clean Architecture 的核心原則
- ✅ 具有良好的可測試性
- ✅ 具有良好的可維護性
- ✅ 具有良好的可擴展性
