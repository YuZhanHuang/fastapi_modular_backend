# 依賴注入流程詳解

本文檔詳細說明從 HTTP 請求到 Service 實例創建的完整依賴注入流程。

---

## 完整流程圖

```
HTTP 請求
    ↓
[步驟 1] FastAPI 路由處理
    ↓
[步驟 2] FastAPI Depends() 觸發
    ↓
[步驟 3] api/deps.py 的 get_cart_service()
    ↓
[步驟 4] 調用 get_service(CartService, session)
    ↓
[步驟 5] 創建 DependencyResolver
    ↓
[步驟 6] 解析 Service 依賴
    ↓
[步驟 7] 獲取註冊表（首次使用時自動初始化）
    ↓
[步驟 8] 自動發現機制掃描組件
    ↓
[步驟 9] 建立 Repository 映射
    ↓
[步驟 10] 解析每個依賴類型
    ↓
[步驟 11] 創建 Repository 實例
    ↓
[步驟 12] 創建 Service 實例並注入依賴
    ↓
[步驟 13] 返回 Service 實例給路由處理函數
```

---

## 詳細步驟說明

### 階段一：HTTP 請求進入

#### 步驟 1：FastAPI 路由處理

**位置：** `api/v1/carts.py`

```python
@router.get("/cart", response_model=CartOut)
def get_cart(
    user_id: str,
    service: CartService = Depends(get_cart_service),  # ← 觸發依賴注入
):
    cart = service.get_cart(user_id)
    # ...
```

**說明：**
- FastAPI 發現 `service` 參數有 `Depends(get_cart_service)`
- 觸發 FastAPI 的依賴注入機制

---

### 階段二：FastAPI 依賴注入

#### 步驟 2：FastAPI Depends() 執行

**位置：** FastAPI 內部機制

**執行過程：**
1. FastAPI 調用 `get_cart_service()` 函數
2. 檢查 `get_cart_service()` 的參數依賴
3. 發現需要 `session` 參數，調用 `get_session()`

**代碼：**
```python
# FastAPI 內部執行類似：
session = get_session()  # 創建資料庫 Session
service = get_cart_service(session=session)  # 調用依賴函數
```

---

#### 步驟 3：執行 api/deps.py 的 get_cart_service()

**位置：** `api/deps.py`

```python
def get_cart_service(
    session=Depends(get_session),  # ← FastAPI 自動注入 Session
) -> CartService:
    return get_service(CartService, session)  # ← 調用泛型工廠
```

**說明：**
- `session` 已由 FastAPI 通過 `Depends(get_session)` 注入
- 調用 `get_service(CartService, session)` 開始自動化依賴注入

---

### 階段三：泛型工廠處理

#### 步驟 4：調用 get_service() 泛型工廠

**位置：** `infra/wiring/factories.py`

```python
def get_service(service_type: Type[T], session: Session) -> T:
    resolver = DependencyResolver(session)  # ← 創建依賴解析器
    dependencies = resolver.resolve_service_dependencies(service_type)  # ← 解析依賴
    return service_type(**dependencies)  # ← 創建 Service 實例
```

**說明：**
- 接收 `CartService` 類別和 `session` 參數
- 創建 `DependencyResolver` 實例
- 開始解析 `CartService` 的依賴

---

#### 步驟 5：創建 DependencyResolver

**位置：** `infra/wiring/dependency_resolver.py`

```python
class DependencyResolver:
    def __init__(self, session: Session):
        self.session = session  # 保存 Session 實例
        self._cache: Dict[Type, Any] = {}  # 初始化依賴快取
```

**說明：**
- 保存 `session` 供後續使用
- 初始化依賴快取（避免重複創建相同依賴）

---

### 階段四：解析 Service 依賴

#### 步驟 6：解析 Service 的 __init__ 簽名

**位置：** `infra/wiring/dependency_resolver.py` → `resolve_service_dependencies()`

```python
def resolve_service_dependencies(self, service_class: Type) -> Dict[str, Any]:
    dependencies = {}
    
    # 獲取 __init__ 方法的簽名
    init_signature = inspect.signature(service_class.__init__)
    # 結果：<Signature (self, cart_repo: CartRepository)>
    
    # 跳過 self 參數
    for param_name, param in list(init_signature.parameters.items())[1:]:
        # param_name = "cart_repo"
        # param.annotation = CartRepository
        param_type = param.annotation
        
        # 解析依賴
        dependency_instance = self._resolve_dependency(param_type)
        dependencies[param_name] = dependency_instance
    
    return dependencies  # {"cart_repo": CartRepositoryImpl實例}
```

**說明：**
- 使用 `inspect.signature()` 分析 `CartService.__init__` 的簽名
- 發現參數：`cart_repo: CartRepository`
- 對每個參數類型調用 `_resolve_dependency()` 解析

---

#### 步驟 7：獲取註冊表（首次使用時自動初始化）

**位置：** `infra/wiring/dependency_resolver.py` → `_resolve_dependency()`

```python
def _resolve_dependency(self, dependency_type: Type) -> Any:
    # dependency_type = CartRepository
    
    # 處理 Repository 類型
    registry = get_registry()  # ← 獲取全局註冊表
    impl_class = registry.get_repository_implementation(dependency_type)
    # ...
```

**位置：** `infra/wiring/registry.py` → `get_repository_implementation()`

```python
def get_repository_implementation(self, interface: Type) -> Optional[Type]:
    if not self._initialized:
        self.initialize()  # ← 首次使用時自動初始化
    
    return self._repository_map.get(interface)
```

**說明：**
- 首次調用時，註冊表尚未初始化
- 觸發 `initialize()` 方法開始自動發現

---

### 階段五：自動發現機制

#### 步驟 8：自動發現機制掃描組件

**位置：** `infra/wiring/registry.py` → `initialize()`

```python
def initialize(self):
    if self._initialized:
        return
    
    # 自動發現並註冊
    self._repository_map = discover_repositories()  # ← 掃描 Repository
    self._services = discover_services()  # ← 掃描 Service
    self._initialized = True
```

**位置：** `infra/wiring/auto_discovery.py` → `discover_repositories()`

```python
def discover_repositories() -> Dict[Type, Type]:
    repository_map: Dict[Type, Type] = {}
    
    # 掃描 core/repositories/ 目錄
    core_repos_path = Path(...) / "core" / "repositories"
    # 找到：cart_repository.py
    
    # 掃描 infra/db/repositories/ 目錄
    infra_repos_path = Path(...) / "db" / "repositories"
    # 找到：cart_repository_impl.py
    
    # 獲取所有 Repository 接口
    repo_interfaces = _scan_repository_interfaces(core_repos_path)
    # 結果：{"CartRepository": <class 'CartRepository'>}
    
    # 獲取所有 RepositoryImpl 實作
    repo_implementations = _scan_repository_implementations(infra_repos_path)
    # 結果：{"CartRepositoryImpl": <class 'CartRepositoryImpl'>}
    
    # 建立映射關係（基於命名約定）
    for interface_name, interface_class in repo_interfaces.items():
        impl_name = interface_name.replace("Repository", "RepositoryImpl")
        # "CartRepository" → "CartRepositoryImpl"
        
        if impl_name in repo_implementations:
            repository_map[interface_class] = repo_implementations[impl_name]
            # {CartRepository: CartRepositoryImpl}
    
    return repository_map
```

**詳細掃描過程：**

**8.1 掃描 Repository 接口**
```python
def _scan_repository_interfaces(repos_path: Path) -> Dict[str, Type]:
    # 掃描 core/repositories/*_repository.py
    # 找到：cart_repository.py
    
    # 動態導入模組
    module = importlib.import_module("app.core.repositories.cart_repository")
    
    # 查找 Repository 類別（繼承 ABC 的類別）
    for name, obj in inspect.getmembers(module, inspect.isclass):
        if name.endswith("Repository") and inspect.isabstract(obj):
            # 找到：CartRepository
            interfaces[name] = obj
```

**8.2 掃描 RepositoryImpl 實作**
```python
def _scan_repository_implementations(repos_path: Path) -> Dict[str, Type]:
    # 掃描 infra/db/repositories/*_repository_impl.py
    # 找到：cart_repository_impl.py
    
    # 動態導入模組
    module = importlib.import_module("app.infra.db.repositories.cart_repository_impl")
    
    # 查找 RepositoryImpl 類別
    for name, obj in inspect.getmembers(module, inspect.isclass):
        if name.endswith("RepositoryImpl") and not inspect.isabstract(obj):
            # 找到：CartRepositoryImpl
            implementations[name] = obj
```

**8.3 建立映射關係**
```python
# 基於命名約定建立映射
"CartRepository" → "CartRepositoryImpl"
# 結果：{CartRepository: CartRepositoryImpl}
```

---

#### 步驟 9：建立 Repository 映射並返回

**位置：** `infra/wiring/registry.py`

```python
# 註冊表現在包含：
self._repository_map = {
    CartRepository: CartRepositoryImpl
}
```

**說明：**
- 註冊表初始化完成
- 返回 `CartRepositoryImpl` 類別給依賴解析器

---

### 階段六：解析依賴類型

#### 步驟 10：解析每個依賴類型

**位置：** `infra/wiring/dependency_resolver.py` → `_resolve_dependency()`

```python
def _resolve_dependency(self, dependency_type: Type) -> Any:
    # dependency_type = CartRepository
    
    # 檢查快取
    if dependency_type in self._cache:
        return self._cache[dependency_type]  # 如果已創建，直接返回
    
    # 處理 Session 類型
    if dependency_type == Session:
        return self.session  # 直接返回 Session
    
    # 處理 Repository 類型
    registry = get_registry()
    impl_class = registry.get_repository_implementation(dependency_type)
    # impl_class = CartRepositoryImpl
    
    if impl_class:
        # 創建 Repository 實例
        instance = self._create_repository_instance(impl_class)
        self._cache[dependency_type] = instance  # 快取實例
        return instance
```

**說明：**
- 檢查快取（避免重複創建）
- 如果是 `Session` 類型，直接返回
- 如果是 `Repository` 類型，從註冊表獲取實作類別
- 創建 Repository 實例並快取

---

#### 步驟 11：創建 Repository 實例

**位置：** `infra/wiring/dependency_resolver.py` → `_create_repository_instance()`

```python
def _create_repository_instance(self, impl_class: Type) -> Any:
    # impl_class = CartRepositoryImpl
    
    # 檢查 __init__ 簽名，確定需要的參數
    init_signature = inspect.signature(impl_class.__init__)
    # 結果：<Signature (self, session: Session)>
    
    params = {}
    
    for param_name, param in list(init_signature.parameters.items())[1:]:
        # param_name = "session"
        # param_type = Session
        param_type = param.annotation
        
        if param_type == Session:
            params[param_name] = self.session  # 注入 Session
        elif param_type != inspect.Parameter.empty:
            # 遞迴解析其他依賴（如果 Repository 依賴其他組件）
            dependency = self._resolve_dependency(param_type)
            if dependency is not None:
                params[param_name] = dependency
    
    # params = {"session": <Session實例>}
    return impl_class(**params)  # CartRepositoryImpl(session=session)
```

**說明：**
- 分析 `CartRepositoryImpl.__init__` 的簽名
- 發現需要 `session: Session` 參數
- 使用已保存的 `self.session` 創建實例
- 返回 `CartRepositoryImpl` 實例

---

### 階段七：創建 Service 實例

#### 步驟 12：創建 Service 實例並注入依賴

**位置：** `infra/wiring/factories.py` → `get_service()`

```python
def get_service(service_type: Type[T], session: Session) -> T:
    resolver = DependencyResolver(session)
    dependencies = resolver.resolve_service_dependencies(service_type)
    # dependencies = {"cart_repo": <CartRepositoryImpl實例>}
    
    return service_type(**dependencies)
    # 等同於：CartService(cart_repo=<CartRepositoryImpl實例>)
```

**說明：**
- 所有依賴已解析完成
- 使用 `**dependencies` 展開參數
- 創建 `CartService` 實例並注入 `CartRepositoryImpl`

---

#### 步驟 13：返回 Service 實例給路由處理函數

**位置：** `api/v1/carts.py`

```python
@router.get("/cart", response_model=CartOut)
def get_cart(
    user_id: str,
    service: CartService = Depends(get_cart_service),  # ← Service 實例已注入
):
    cart = service.get_cart(user_id)  # ← 使用 Service
    # ...
```

**說明：**
- `service` 參數已包含完整的 `CartService` 實例
- `CartService` 內部已注入 `CartRepositoryImpl`
- `CartRepositoryImpl` 內部已注入 `Session`
- 可以正常使用 Service 的方法

---

## 完整代碼執行順序

### 實際執行順序

1. **HTTP 請求到達** → `GET /api/v1/cart?user_id=123`

2. **FastAPI 路由匹配** → `api/v1/carts.py::get_cart()`

3. **FastAPI 發現依賴** → `service: CartService = Depends(get_cart_service)`

4. **執行 get_session()** → 創建資料庫 Session

5. **執行 get_cart_service(session)** → `api/deps.py`

6. **調用 get_service(CartService, session)** → `infra/wiring/factories.py`

7. **創建 DependencyResolver** → 保存 session

8. **解析依賴** → `resolve_service_dependencies(CartService)`

9. **分析 __init__ 簽名** → 發現 `cart_repo: CartRepository`

10. **獲取註冊表** → `get_registry()`（首次使用）

11. **註冊表初始化** → `initialize()`（首次使用）

12. **自動發現 Repository** → `discover_repositories()`

13. **掃描 core/repositories/** → 找到 `CartRepository`

14. **掃描 infra/db/repositories/** → 找到 `CartRepositoryImpl`

15. **建立映射** → `{CartRepository: CartRepositoryImpl}`

16. **返回實作類別** → `CartRepositoryImpl`

17. **創建 Repository 實例** → `CartRepositoryImpl(session=session)`

18. **快取實例** → 避免重複創建

19. **返回依賴字典** → `{"cart_repo": <CartRepositoryImpl實例>}`

20. **創建 Service 實例** → `CartService(cart_repo=<CartRepositoryImpl實例>)`

21. **返回給 FastAPI** → Service 實例注入到路由函數

22. **執行業務邏輯** → `service.get_cart(user_id)`

---

## 關鍵數據結構變化

### 註冊表狀態（首次使用後）

```python
_registry = DependencyRegistry(
    _repository_map={
        CartRepository: CartRepositoryImpl
    },
    _services=[CartService],
    _initialized=True
)
```

### 依賴解析器狀態

```python
resolver = DependencyResolver(
    session=<Session實例>,
    _cache={
        CartRepository: <CartRepositoryImpl實例>
    }
)
```

### 最終創建的對象

```python
service = CartService(
    cart_repo=CartRepositoryImpl(
        session=<Session實例>,
        __model__=CartItemModel
    )
)
```

---

## 流程特點

### 1. 延遲初始化（Lazy Initialization）

- 註冊表在首次使用時才初始化
- 避免應用啟動時的掃描開銷
- 只在需要時才執行自動發現

### 2. 依賴快取

- 相同類型的依賴只創建一次
- 避免重複創建相同的 Repository 實例
- 提高性能

### 3. 自動發現

- 基於命名約定自動掃描
- 無需手動註冊
- 新增實體時自動識別

### 4. 遞迴解析

- 支持 Repository 依賴其他組件
- 自動處理嵌套依賴
- 無限層級的依賴解析

---

## 範例：複雜依賴場景

如果 `OrderService` 依賴多個 Repository：

```python
class OrderService:
    def __init__(
        self,
        order_repo: OrderRepository,
        product_repo: ProductRepository,
        payment_port: PaymentPort
    ):
        # ...
```

**解析流程：**

1. 分析 `__init__` 簽名 → 發現 3 個依賴
2. 解析 `order_repo: OrderRepository` → 創建 `OrderRepositoryImpl`
3. 解析 `product_repo: ProductRepository` → 創建 `ProductRepositoryImpl`
4. 解析 `payment_port: PaymentPort` → 未來擴展（目前返回 None）
5. 創建 `OrderService` 實例並注入所有依賴

**無需手動組裝！**

---

## 總結

整個依賴注入流程實現了：

1. ✅ **自動發現** - 基於命名約定自動掃描組件
2. ✅ **自動映射** - 自動建立 Repository 接口到實作的映射
3. ✅ **自動解析** - 自動識別 Service 的依賴
4. ✅ **自動注入** - 自動創建並注入所有依賴
5. ✅ **統一管理** - 通過註冊表統一管理所有依賴關係

**結果：新增實體時無需修改 `wiring.py`，完全自動化！**

